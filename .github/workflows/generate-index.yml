name: ç”Ÿæˆç›®å½•ç´¢å¼•

on:
  push:
    paths:
      - 'data/resource/**'
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-index:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç ï¼ˆå¯ç”¨å®Œæ•´å†å²è®°å½•å’Œæ–‡ä»¶çŠ¶æ€è·Ÿè¸ªï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–æ‰€æœ‰å†å²ï¼Œä¾¿äºå¯¹æ¯”
          
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ç”Ÿæˆç›®å½•ç´¢å¼•
        run: |
          python .github/scripts/generate_index.py

      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç´¢å¼•æ–‡ä»¶ç”Ÿæˆ
        id: check_files
        run: |
          # å…³é”®ä¿®æ”¹ï¼šç›´æ¥æ£€æŸ¥æ˜¯å¦æœ‰index.htmlæ–‡ä»¶è¢«ç”Ÿæˆ/ä¿®æ”¹
          # æŸ¥æ‰¾æ‰€æœ‰æ–°ç”Ÿæˆæˆ–æ›´æ–°çš„index.htmlæ–‡ä»¶
          NEW_INDEX_FILES=$(find data/resource -name "index.html" -type f)
          
          if [ -z "$NEW_INDEX_FILES" ]; then
            echo "æœªæ‰¾åˆ°ä»»ä½•index.htmlæ–‡ä»¶"
            echo "has_new_files=false" >> $GITHUB_OUTPUT
          else
            echo "æ‰¾åˆ°çš„ç´¢å¼•æ–‡ä»¶ï¼š"
            echo "$NEW_INDEX_FILES"
            echo "has_new_files=true" >> $GITHUB_OUTPUT
            
            # å°†æ–‡ä»¶åˆ—è¡¨ä¿å­˜åˆ°ç¯å¢ƒå˜é‡ï¼Œä¾›ä¸‹ä¸€æ­¥ä½¿ç”¨
            echo "file_list<<EOF" >> $GITHUB_ENV
            echo "$NEW_INDEX_FILES" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi

      - name: æäº¤ç´¢å¼•æ–‡ä»¶
        if: steps.check_files.outputs.has_new_files == 'true'
        run: |
          # é…ç½®Gitç”¨æˆ·
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ·»åŠ æ‰€æœ‰æ‰¾åˆ°çš„index.htmlæ–‡ä»¶
          echo "æ­£åœ¨æ·»åŠ ä»¥ä¸‹æ–‡ä»¶ï¼š"
          echo "${{ env.file_list }}"
          
          # é€è¡Œå¤„ç†æ–‡ä»¶åˆ—è¡¨ï¼Œç¡®ä¿æ¯ä¸ªæ–‡ä»¶éƒ½è¢«æ·»åŠ 
          echo "${{ env.file_list }}" | while read -r file; do
            if [ -f "$file" ]; then
              git add "$file"
              echo "å·²æ·»åŠ : $file"
            fi
          done
          
          # æäº¤æ›´æ”¹
          git status
          git commit -m "ğŸ“ è‡ªåŠ¨æ›´æ–°ç›®å½•ç´¢å¼• [skip ci]" || echo "æ²¡æœ‰éœ€è¦æäº¤çš„å†…å®¹"
          
          # æ¨é€æ›´æ”¹
          git push