name: Purge jsDelivr Cache on Update

on:
  push:
    branches: [ main, master ]
    paths:
      - 'js/oversea_codes.js'
      - 'images/calendar.jpg'
  workflow_dispatch:

jobs:
  check-changes:
    name: Check for changed files
    runs-on: ubuntu-latest
    outputs:
      js_changed: ${{ steps.check-files.outputs.js_changed }}
      jpg_changed: ${{ steps.check-files.outputs.jpg_changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¾¿å‡†ç¡®æ¯”è¾ƒ

      - name: Check modified files
        id: check-files
        run: |
          # æ›´å¯é çš„å˜æ›´æ£€æµ‹æ–¹æ³•
          echo "Last commit: $(git log -1 --oneline)"
          echo "Previous commit: $(git log -2 --oneline | tail -1)"
          
          # ä½¿ç”¨æ›´ç²¾ç¡®çš„gitå‘½ä»¤æ£€æµ‹å˜æ›´
          if git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | grep -q "^js/oversea_codes.js$"; then
            echo "js_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… JS file was changed"
          else
            echo "js_changed=false" >> $GITHUB_OUTPUT
            echo "âŒ JS file was not changed"
          fi

          if git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | grep -q "^images/calendar.jpg$"; then
            echo "jpg_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… JPG file was changed"
          else
            echo "jpg_changed=false" >> $GITHUB_OUTPUT
            echo "âŒ JPG file was not changed"
          fi
          
          # è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºæ‰€æœ‰å˜æ›´çš„æ–‡ä»¶
          echo "All changed files:"
          git diff --name-only ${{ github.event.before }} ${{ github.event.after }} || echo "æ— æ³•è·å–å˜æ›´æ–‡ä»¶åˆ—è¡¨"

  purge-cache:
    name: Purge jsDelivr Cache (Conditional)
    runs-on: ubuntu-latest
    needs: check-changes
    # åªæœ‰å½“æ–‡ä»¶çœŸæ­£å˜æ›´æ—¶æ‰è¿è¡Œæ­¤job
    if: needs.check-changes.outputs.js_changed == 'true' || needs.check-changes.outputs.jpg_changed == 'true'
    steps:
      - name: Purge oversea_codes.js (if changed)
        if: needs.check-changes.outputs.js_changed == 'true'
        run: |
          echo "ğŸ”„ Purging JS file from jsDelivr cache..."
          response=$(curl -s -w "%{http_code}" "https://purge.jsdelivr.net/gh/${{ github.repository }}@main/js/oversea_codes.js")
          http_code=${response: -3}
          if [ "$http_code" = "200" ]; then
            echo "âœ… Successfully purged JS file cache"
          else
            echo "âŒ Failed to purge JS file cache. HTTP code: $http_code"
          fi

      - name: Purge calendar.jpg (if changed)
        if: needs.check-changes.outputs.jpg_changed == 'true'
        run: |
          echo "ğŸ”„ Purging Image file from jsDelivr cache..."
          response=$(curl -s -w "%{http_code}" "https://purge.jsdelivr.net/gh/${{ github.repository }}@main/images/calendar.jpg")
          http_code=${response: -3}
          if [ "$http_code" = "200" ]; then
            echo "âœ… Successfully purged Image file cache"
          else
            echo "âŒ Failed to purge Image file cache. HTTP code: $http_code"
          fi

  no-changes:
    name: No changes detected
    runs-on: ubuntu-latest
    needs: check-changes
    # åªæœ‰å½“æ²¡æœ‰æ–‡ä»¶å˜æ›´æ—¶æ‰è¿è¡Œæ­¤job
    if: needs.check-changes.outputs.js_changed != 'true' && needs.check-changes.outputs.jpg_changed != 'true'
    steps:
      - name: Notify no changes
        run: |
          echo "â„¹ï¸ No targeted files (js/oversea_codes.js or images/calendar.jpg) were changed in this commit."
          echo "Skipping cache purge."